# 动态链接

动态链接一开始以为很复杂，但内核的实现非常简单。

忽略复杂的理论部分，支持动态链接只需要：

* 在用户虚拟地址空间中选择一个你喜欢的，能放得下动态链接器的地址区间。对于libc.so (2022 comp)，它需要0xa7218，约1MB。
* 在auxv向量中将AT_BASE向量修改为你的选择的地址范围的起始点。
* 将动态链接器像加载普通程序一样加载到地址空间中，但需要按你选择的基址偏移。
* 将用户入口指令地址修改为动态链接器的入口地址，但需要按你选择的基址偏移。不要修改AT_ENTRY，动态链接器需要它来进入用户程序。
* 尝试运行需要动态链接器的程序，虽然大概率会运行失败，但只要不是指令页错误(jr (NULL))而是提示找不到共享库就是大成功。
* 动态链接器会使用openat来寻找用户使用的动态库，它会去`/etc/ld-musl-riscv64-sf.path`寻找动态库路径，请参考Linux手动放置此文件。
* 动态链接器会使用mmap来自动加载用户需要的共享库，请确保mmap系统调用能正常运行，并实现FIXED标志位的功能。
* 你成功地运行了需要动态链接的程序。

为什么看起来很复杂的动态链接并不需要内核增加太多功能？因为动态链接器是运行在用户态的，动态链接的复杂逻辑都是由它完成的。